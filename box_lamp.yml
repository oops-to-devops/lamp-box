---
- hosts: lamp_box
  gather_facts: False

  vars:
    - root_dir: "{{ playbook_dir }}"
    - shared_dir: "{{ playbook_dir }}/../shared"

  vars_files:
    - ./lamp_vars.yml

  pre_tasks:
    - debug: msg="Pre tasks section"
      tags: always

    - name: ANSIBLE PYTHON | install python 2
      raw: test -e /usr/bin/python || (apt -qqy update && apt install -qy python-minimal)
      become: yes
      tags: always

    - name:  UNPRIVILEGED USERS | Get acl dependency (ansible unprivileged user operations magic)
      apt: pkg="acl"
      become: yes
      tags: always

    - name: gather facts
      setup:
      tags: always

    - name: Check for common pretasks
      local_action: stat path="{{shared_dir}}/common_pretasks.yml"
      register: common_pretasks_exists
      tags: always

    - name: Include common pretasks
      include_tasks: "{{shared_dir}}/common_pretasks.yml"
      when: common_pretasks_exists.stat.exists == true
      tags: always

  roles:

      - {
           role: "sa-apache",
           tags: [create, sa_apache]
        }

      - {
         role: "sa-php-fpm",
         php_family: "{{ box_php_family }}", # 5.6  | 7.0 | hhvm |  default
         option_install_xdebug: "{{box_option_install_xdebug}}",
         custom_pool_properties: "{{box_php_pool_properties}}",
         php_extensions: "{{box_additional_php_extensions}}",
         tags: [create, sa_php_fpm]
        }

  tasks:

    - debug: msg="Pre tasks section"

    - name: POC marker
      copy:
        dest: "/var/www/html/ii.php"
        content: |
          <?php
          phpinfo();
      become: yes

    - block:

       - name: Configure apache2 for php (a2enmod)
         shell: a2enmod actions fastcgi alias proxy_fcgi
         become: yes

       - name: Configure apache2 for php (a2enconf)
         shell: a2enconf php7.0-fpm
         become: yes

       - name: Restart apache
         service: name="apache2" state="restarted"
         become: yes

      tags:
        - sa_apache




       
